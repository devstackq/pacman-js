const mapGame = [
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  4,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  4,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  6,
  6,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  9,
  9,
  9,
  9,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  8,
  9,
  9,
  9,
  9,
  9,
  9,
  0,
  9,
  9,
  9,
  1,
  1,
  2,
  2,
  2,
  2,
  1,
  1,
  9,
  9,
  9,
  0,
  9,
  9,
  9,
  9,
  9,
  9,
  8,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  4,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  9,
  9,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  4,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
];
//1 wall, 0 coin, 4 cookie, 8 teleport, 3 -empty, 9 freepath

const directsX = ["left", "right"];
const directsY = ["up", "down"];
let killTimer = null;

const keys = {
  ArrowLeft: false,
  ArrowRight: false,
  ArrowUp: false,
  ArrowDown: false,
};

const units = {
  pinkGhost: {
    nick: "pinkGhost",
    name: "PinkÄ«",
    posX: 360,
    posY: 420,
    basePos: 404,
    direct: "right",
    color: "pink",
    freeze: false,
    base: false,
    type: "square",
    intersect: false,
  },
  orangeGhost: {
    nick: "orangeGhost",
    name: "Guzuta",
    posX: 390,
    posY: 420,
    basePos: 405,
    direct: "up",
    color: "orange",
    freeze: false,
    base: false,
    type: "perimeter",
    intersect: false,
  },
  redGhost: {
    nick: "redGhost",
    name: "Akabei",
    posX: 420,
    posY: 420,
    basePos: 406,
    direct: "up",
    color: "red",
    freeze: false,
    base: false,
    type: "perimeter",
    intersect: false,
  },
  cyanGhost: {
    nick: "cyanGhost",
    name: "Aosuke",
    posX: 450,
    posY: 420,
    basePos: 407,
    direct: "left",
    color: "cyan",
    freeze: false,
    base: false,
    type: "",
    intersect: false,
  },
  pacman: {
    posX: 425, //def posX - transform translate
    posY: 695,
    score: 0,
    life: 5,
    indexMap: 658, // index for work []MapGame
    canKill: false, // coin eate
    countCoin: 0,
    killTime: 10000,
    transX: "", // change mouse pos
    direct: undefined,
    restart: false,
  },
  cool: 0,
};

//if pacman eat cookie - canKill ghost
const killGhost = (time) => {
  if (units.pacman.canKill) {
    // obj.pacman.style.backgroundColor = "red";
    killTimer = setTimeout(() => {
      units.pacman.canKill = false;
      // obj.pacman.style.backgroundColor = "#fff";
    }, time); //10sec
  }
};

const intravenousPerimeter = (ghost) => {
  const randomNumber = Math.floor(Math.random() * 2);
  ghost.basePos = Math.floor((ghost.posY / 30) * 28 + ghost.posX / 30);
  //go out box
  if ((!ghost.goOutBox && ghost.basePos === 377) || ghost.basePos === 378) {
    ghost.direct = "up";
    ghost.goOutBox = false;
  }
  //turnNow()
  if (ghost.direct === "left") {
    // if not wall, != another ghost || equal pacman
    if (mapGame[ghost.basePos - 1] !== 1 && ghost.basePos - 1 !== 567) {
      if (ghost.basePos - 1 === 323 || ghost.basePos - 1 === 569) {
        ghost.direct = "up";
      }
      //teleport case
      if (ghost.basePos - 1 === 392) {
        ghost.direct = "right";
      }
      ghost.basePos -= 1;
      ghost.posX -= 30;
    } else {
      ghost.direct = directsY[randomNumber];
    }
  } else if (ghost.direct === "right") {
    if (mapGame[ghost.basePos + 1] !== 1 && ghost.basePos + 1 !== 581) {
      if (ghost.basePos + 1 === 321 || ghost.basePos + 1 === 578) {
        ghost.direct = "up";
      }
      //teleport
      if (ghost.basePos + 1 === 419) {
        ghost.direct = "left";
      }
      ghost.basePos += 1;
      ghost.posX += 30;
    } else {
      ghost.direct = directsY[randomNumber];
    }
  } else if (ghost.direct === "up") {
    if (
      mapGame[ghost.basePos - 28] !== 1 &&
      ghost.basePos - 28 !== 149 &&
      ghost.basePos - 28 !== 158
    ) {
      //ghost.basePos - 28 === 494 ||
      if (ghost.basePos - 28 === 401) {
        ghost.direct = "left";
      }
      if (ghost.basePos - 28 === 410) {
        ghost.direct = "right";
      }
      ghost.posY -= 30;
      ghost.basePos -= 28;
    } else {
      ghost.direct = directsX[randomNumber];
    }
  } else if (ghost.direct === "down") {
    if (
      mapGame[ghost.basePos + 28] !== 1 &&
      ghost.basePos + 28 !== 656 &&
      ghost.basePos + 28 !== 659
    ) {
      if (ghost.basePos + 28 === 485) {
        ghost.direct = "right";
      }
      ghost.posY += 30;
      ghost.basePos += 28;
    } else {
      ghost.direct = directsX[randomNumber];
    }
  }
};

const findAndDestroy = (ghost) => {
  let randomNumber = Math.floor(Math.random() * 2);

  ghost.basePos = Math.floor((ghost.posY / 30) * 28 + ghost.posX / 30);

  // if (ghost.type === "square") {
  if ((!ghost.goOutBox && ghost.basePos === 377) || ghost.basePos === 378) {
    ghost.direct = "up";
    ghost.goOutBox = false;
  }

  if (ghost.direct === "left") {
    if (mapGame[ghost.basePos - 1] !== 1) {
      if (ghost.type == "square") {
        if (ghost.direct === "left") {
          if (ghost.basePos - 1 === 146 || ghost.basePos - 1 === 653) {
            ghost.direct = "down";
          }
          if (ghost.basePos - 1 === 824 || ghost.basePos - 1 === 650) {
            ghost.direct = "up";
          }
        }
      }
      ghost.basePos -= 1;
      ghost.posX -= 30;
    } else {
      ghost.direct = directsY[randomNumber];
    }
  } else if (ghost.direct === "right") {
    if (mapGame[ghost.basePos + 1] !== 1) {
      if (ghost.type === "square") {
        if (ghost.direct === "right") {
          if (ghost.basePos + 1 === 827 || ghost.basePos + 1 === 665) {
            ghost.direct = "up";
          }
          if (ghost.basePos + 1 === 161 || ghost.basePos + 1 === 662) {
            ghost.direct = "down";
          }
        }
      }
      ghost.basePos += 1;
      ghost.posX += 30;
    } else {
      ghost.direct = directsY[randomNumber];
    }
  } else if (ghost.direct === "up") {
    if (mapGame[ghost.basePos - 28] !== 1) {
      if (ghost.type === "square") {
        if (ghost.direct === "up") {
          if (ghost.basePos - 28 === 161) {
            ghost.direct = "left";
          }
          if (ghost.basePos - 28 === 146) {
            ghost.direct = "right";
          }
        }
      }
      ghost.posY -= 30;
      ghost.basePos -= 28;
    } else {
      ghost.direct = directsX[randomNumber];
    }
  } else if (ghost.direct === "down") {
    if (mapGame[ghost.basePos + 28] !== 1) {
      if (ghost.type === "square") {
        if (ghost.direct === "down") {
          if (ghost.basePos + 28 === 665) {
            ghost.direct = "left";
          }
          if (ghost.basePos + 28 === 650) {
            ghost.direct = "right";
          }
        }
      }
      ghost.posY += 30;
      ghost.basePos += 28;
    } else {
      ghost.direct = directsX[randomNumber];
    }
  }
};
//DRY, clean arch
const killPacman = (direct, type) => {
  let second = units.pacman.indexMap;
  //currentPos & nextPos byDirect pacman - check if interesct any ghost
  if (direct === "left") {
    second -= 1;
  } else if (direct === "right") {
    second += 1;
  } else if (direct === "up") {
    second -= 28;
  } else if (direct === "down") {
    second += 28;
  }

  if (second === units.redGhost.basePos) {
    units.redGhost.intersect = true;
  } else if (second === units.cyanGhost.basePos) {
    units.cyanGhost.intersect = true;
  } else if (second === units.pinkGhost.basePos) {
    units.pinkGhost.intersect = true;
  } else if (second === units.orangeGhost.basePos) {
    units.orangeGhost.intersect = true;
  }
  if (units.pacman.indexMap === units.redGhost.basePos) {
    units.redGhost.intersect = true;
  } else if (units.pacman.indexMap === units.cyanGhost.basePos) {
    units.cyanGhost.intersect = true;
  } else if (units.pacman.indexMap === units.pinkGhost.basePos) {
    units.pinkGhost.intersect = true;
  } else if (units.pacman.indexMap === units.orangeGhost.basePos) {
    units.orangeGhost.intersect = true;
  }

  if (type === "pacman") {
    if (
      units.redGhost.intersect ||
      units.cyanGhost.intersect ||
      units.pinkGhost.intersect ||
      units.orangeGhost.intersect
    ) {
      units.pacman.life--;
      units.pacman.posX = 425;
      units.pacman.posY = 695;
      units.pacman.indexMap = 658;
      units.redGhost.intersect = false;
      units.orangeGhost.intersect = false;
      units.pinkGhost.intersect = false;
      units.cyanGhost.intersect = false;
    }
  }

  if (type === "ghost") {
    if (units.redGhost.intersect) {
      units.redGhost.direct = "up";
      units.redGhost.intersect = false;
      units.redGhost.posX = 420;
      units.redGhost.posY = 420;
      units.redGhost.basePos = 406;
      units.pacman.score += 200;
    }
    if (units.orangeGhost.intersect) {
      units.orangeGhost.direct = "up";
      units.orangeGhost.intersect = false;
      units.orangeGhost.posX = 390;
      units.orangeGhost.posY = 420;
      units.orangeGhost.basePos = 405;
      units.pacman.score += 200;
    }
    if (units.pinkGhost.intersect) {
      units.pinkGhost.direct = "right";
      units.pinkGhost.intersect = false;
      units.pinkGhost.posX = 360;
      units.pinkGhost.posY = 420;
      units.pinkGhost.basePos = 404;
      units.pacman.score += 200;
    }
    if (units.cyanGhost.intersect) {
      units.cyanGhost.direct = "left";
      units.cyanGhost.intersect = false;
      units.cyanGhost.posX = 450;
      units.cyanGhost.posY = 420;
      units.cyanGhost.basePos = 407;
      units.pacman.score += 200;
    }
  }
};

const pacmanMove = (keys) => {
  units.pacman.restart = keys.restart;
  units.pacman.indexMap = Math.floor(
    ((units.pacman.posY - 5) / 30) * 28 + (units.pacman.posX - 5) / 30
  );
  if (units.pacman.restart) {
    units.pacman.posX = 425;
    units.pacman.posY = 695;
    units.pacman.countCoin = 0;

    units.orangeGhost.basePos = 405;
    units.pinkGhost.basePos = 404;
    units.redGhost.basePos = 406;
    units.cyanGhost.basePos = 407;
    units.pinkGhost.posX = 360;
    units.pinkGhost.posY = 420;
    units.orangeGhost.posX = 390;
    units.orangeGhost.posY = 420;
    units.cyanGhost.posX = 450;
    units.cyanGhost.posY = 420;
    units.redGhost.posX = 420;
    units.redGhost.posY = 420;

    // ghosts.cool = 0;
    // if (type == "tryAgain") {
    units.pacman.cool = 0;
    units.pacman.life = 5;
    units.pacman.score = 0;
    units.pacman.restart = false;
  }
  //check if key press equal  Right, nextPos in mapGame != 1, update value, goToRight
  if (keys.ArrowLeft) {
    units.pacman.direct = "left";
    if (mapGame[units.pacman.indexMap - 1] !== 1) {
      units.pacman.posX -= 30;
      units.pacman.indexMap -= 1;
      units.pacman.transX = "translateX(0%)";
      //check tele
      if (mapGame[units.pacman.indexMap] === 8) {
        units.pacman.posX += 840;
      }
    }
  } else if (keys.ArrowRight) {
    units.pacman.direct = "right";
    if (mapGame[units.pacman.indexMap + 1] !== 1) {
      //canKill - and intersect -> -life

      units.pacman.indexMap += 1;
      units.pacman.posX += 30;
      units.pacman.transX = "translateX(100%)";

      if (mapGame[units.pacman.indexMap] === 8) {
        units.pacman.posX -= 840;
      }
    }
  } else if (keys.ArrowUp) {
    units.pacman.direct = "up";
    if (mapGame[units.pacman.indexMap - 28] !== 1) {
      units.pacman.indexMap -= 28;
      units.pacman.posY -= 30;
    }
  } else if (keys.ArrowDown) {
    units.pacman.direct = "down";
    if (
      mapGame[units.pacman.indexMap + 28] !== 1 &&
      mapGame[units.pacman.indexMap + 28] !== 6
    ) {
      units.pacman.indexMap += 28;
      units.pacman.posY += 30;
    }
  }
  //if pacman stay 1 position, check interect
  if (!units.pacman.canKill) {
    killPacman(units.pacman.direct, "pacman");
  }
  if (units.pacman.canKill) {
    killPacman(units.pacman.direct, "ghost");
  }

  // if changed pacman index, eqaul 4 || 0, add score, change - currentPos = 0, -> currPos = 9
  if (mapGame[units.pacman.indexMap] !== 1) {
    if (mapGame[units.pacman.indexMap] === 0) {
      units.pacman.score += 10;
      units.pacman.countCoin++;
    }
    //Invulnerable pacman 10 sec
    if (mapGame[units.pacman.indexMap] === 4) {
      units.pacman.score += 50;
      units.pacman.canKill = true;
      clearTimeout(killTimer);
      killGhost(units.pacman.killTime);
      units.pacman.countCoin++; // count coin for - check win game
    }
    if (units.pacman.indexMap !== 420 && units.pacman.indexMap !== 391) {
      mapGame[units.pacman.indexMap] = 9;
    }
  }
};
//connetc -> receive data - call func - send main thread calcualted data
self.onconnect = (e) => {
  const port = e.ports[0];
  port.onmessage = function (e) {
    //get state - goTOBase, if true -> set def value -> freeze 10sec, -> start boxGhost pos
    findAndDestroy(units.redGhost);
    findAndDestroy(units.orangeGhost);
    findAndDestroy(units.pinkGhost);
    intravenousPerimeter(units.cyanGhost);
    pacmanMove(e.data.key);
    //send ghost, and pacman.data
    port.postMessage(units);
  };
};
