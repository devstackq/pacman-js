const mapGame = [
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  4,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  4,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  6,
  6,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  9,
  9,
  9,
  9,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  8,
  9,
  9,
  9,
  9,
  9,
  9,
  0,
  9,
  9,
  9,
  1,
  1,
  2,
  2,
  2,
  2,
  1,
  1,
  9,
  9,
  9,
  0,
  9,
  9,
  9,
  9,
  9,
  9,
  8,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  3,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  3,
  3,
  3,
  3,
  3,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  9,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  9,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  4,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  9,
  9,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  4,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  0,
  1,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
];

//1 wall, 0 coin, 4 cookie, 8 teleport, 3 -empty, 9 freepath

//for work - another thread calculate hard func
const worker = new SharedWorker("worker.js", {
  type: "module",
  name: "sharedWorker",
});

//keys state, l/r/u/d
const keys = {
  KeyA: false,
  KeyD: false,
  KeyW: false,
  KeyS: false,
  restart: false,
  death: false,
};

let rafId = 0;

//manage dom elems - coin opacity
const mapItemsInDom = [];
//for dumping props object, add pacamn & ghost Dom objects
const obj = {};
//clear interval - when temeout 10sec
let interval;

const props = {
  x: "", // for grid row - first render items in Dom - set grid style
  y: "",
  h: 31, // height borad, count Y
  size: 28,
  inPlay: false, // play state
  time: {
    sec: 0,
    min: 0,
  },
  skip: false,
  sceneType: "prologue",
  mainMenu: true,
  finalState: false,
};

//unit objects - for manipualte game
let unitsMT = {
  pinkGhost: {
    posX: 360,
    posY: 420,
    basePos: 404,
    direct: "right",
  },
  orangeGhost: {
    posX: 390,
    posY: 420,
    basePos: 405,
  },
  redGhost: {
    posX: 420,
    posY: 420,
    basePos: 406,
  },
  cyanGhost: {
    posX: 450,
    posY: 420,
    basePos: 407,
    direct: "up",
  },
  pacman: {
    posX: 425,
    posY: 695,
    basePos: 658,
    transX: "",
    indexMap: 0,
    life: 5,
    score: 0,
    countCoin: 0,
    canKill: false,
    gameState: "",
    pause: false,
    lastIndex: 0,
  },
  cool: 0,
};

const history = {
  prologue: [
    "В паралельной вселенной, есть такая планета Noveus2D, это двумерный мир со своими правилами и законами, ее наслеяют разные сказочные обитатели, от лилипутов-жирафов до розовых единорогов. Все они жили мирно счастливо, пока однажды не случилась беда...",
    "На планету упал астероид. Ученые начали выяснять, что это за объект. Проводя эксперементы и исследования, выяснялось что на этом астероиде находится мутирующий вирус...",
    "Он прибыл с другой планеты - Terra, но все это уже было поздно...",
    "В течении 3 дней и 3 ночей, вирус смог заразить ученых и начал распространться по экспоненте.  Черное бремя наступило для сказочных обителей планеты Noveus2D...",
    "Через время появились они... Это те рыцари, великие спасатели, герои нашего времени - прозвали их Пакманами, что означает на древнем языке - беспощадный убийца летучих падонков. Или в простонародии - чистильщики...",
    "Пакманы это бывшие военные, большинство из них потеряли свои семьи из-за летучих падонков, и им уже нечего терять... Пакманы сотрудничают с лабороторией X69, где изучается вирус и разрабатывается вакцина...",
    "В мире их осталось не так много, но те что остались,  идут от города к городу рискуя своей жизнью, что бы очистить этот грязный город BloodyBoobs и вакцинировать зараженных...",
    "Если повезет...",
    "Вирус превращал из любого кто попадался ему на пути - в огромную и сильную летучую мышь, помимо физиологической деформации, вирус также завладевал разумом, что теперь зараженый становился рабом вируса и выполнял функцию распространителя...",
    "Те же кто уже заразился, местные называли их - ",
    "ЛЕТУЧИЕ ПОДОНКИ...",
    "Зараженые интуитивно искали своих здоровых собратьев, обхватив их крыльями они крепко держали жертву  и целовали его в засос...",
    "Так вирус и передовался, процесс был долгим и мучительным...",
    "Вирус заполонил многие города, некоторые вовсе исчахли...",
    "Единственная надежда жителей города BloodyBoobs, это Пакман",
    "Если пакман появляется в городах, то все жители страраются помочь им, даруя жизни и пропитание...",
    "Находи ящики с вакционой Sugar V, с их помощью ты можешь лечить зараженых, не боясь заразиться, т.к летечие подонки бояться Пакманов с вакционой, но время жизни вакцин ограничен...",
    "Имей ввиду, леча одного появится, обязательно появятся новые зараженные, которые будут патрулировать город",
    "Теперь все в твоих руках... В бой юный подован!",
  ],
  takeMedical:
    "Вы нашли ящик с вакционой Спутник V, теперь вы можете лечить зараженых, не боясь заразиться, т.к летечие подонки бояться Пакманов с вакционой, но время жизни вакцин ограничен... Имейте ввиду, леча одного появится обязательно новые зараженные, которые будут патрулировать город",
  death:
    "Ну ничего страшного, тяу тяу тяу. Местные верят в тебя и даруют тебе еще 1 жизнь, но помни, жизни ограничены...",
  lose: [
    "Все те жизни которые были даны Пакману, это души младецнов, ибо только их души способны даровать жизнь...",
    "В городе BloodyBoobs больше не осталось младенцов...(",
    "Местные остались без надежды и теперь они будут умирать долго и мучительно от поцелуев летучих подонков...",
    "Если только не придет, новый чистильщик...",
  ],
  win: [
    "Ты рискуя жизнью, даришь новую жизнь и надежду BloodyBoobs и его жителям!",
    "Дни и ночи не покладая рук ты боролся с нечистью и теперь этот грязный город очищен...",
    "+10 к ЧСВ, +10 к карме, Ты лучший!",
    "Местные благодарны и некотрые даже начали называть своих детей твоим именем...",
    "Оставшихся зараженых вакцинировали и они обратились вновь в себя...",
    "Тебя запомнят как великого и бесстрашного спасителя! И будут рассказывать своим внукам еще не 1 десяток лет...",
    "Несколько дней продолжались гуляния на главной площади...",
    "Но вот что тревожило Пакмана, что есть еще кучу других городов и надо бы туда отправляться...",
    "Отдохнув и набравшився сил, Пакман исчез из BloodyBoobs...",
  ],
};

//dom onladed -> get grid elem, -> append - block, then manipulate this dom object, etc
// document.URL.includes("index.html")
document.addEventListener("DOMContentLoaded", () => {
  //save cache dom in nodes - addres in Ram - > then change by pointer
  props.grid = document.querySelector("div.grid");
  props.modal = document.querySelector("div.modal");
  props.notify = document.querySelector("div.notify");
  props.scoreBoard = document.querySelector("div.scoreBoard");
  obj.pacman = document.querySelector("div.pacman");
  obj.pacman_mouth = document.querySelector("div.pacman_mouth");
  //set default pos in Dom
  obj.redGhost = document.querySelector("div.red");
  obj.orangeGhost = document.querySelector("div.orange");
  obj.pinkGhost = document.querySelector("div.pink");
  obj.cyanGhost = document.querySelector("div.cyan");
  createBoard();
  // startGame();
  console.log("loaded");
  showHide();
  if (!props.mainMenu) {
    props.modal.children[3].style.display = "none";
    beginParty("prologue");
  }
});

document.addEventListener("keyup", (e) => {
  if (e.code in keys) {
    keys[e.code] = false;
  }
});

const startTime = () => {
  props.notify.style.display = "none";
  interval = setInterval(() => {
    props.time.sec += 1;
    props.time.sec === 60 ? ((props.time.sec = 0), (props.time.min += 1)) : 0;
  }, 1000);
};

//TODO
//if frame drop, trans off, off timer
//check fps google
// add audio,
//ref class component

//add instruction modal window  - how to play game
//start project -> History || scorebaord
//coin -> picture -> coronavirus, ghost - mouse fly

//add keyframe - when pacman death

//if win -> bg good, if lose - apocalipse image
//pacman + - как крестоносец, монеты - ковид, призраки мыши
//  ?/разный bg - на сцены
//  transalte - eng
//  score - очищеные улицы от вируса / Max 260, Not 2600 score
//  time - 1 age(min), 2 day(sec)
//  next - opacity - transiiton 2s
//  text in array -> control left/ right - next prev text
//  - show modal[lastElement]

//  1time  когда печеньки next - ящик 4 с вакционой
//  1time когда потерял жизнь, next
//final - все те жизни lose
// find picture, coin, ghot, coin - medical
//  bg, - black, always, if win - bg white

// props.modal.children[5].children[0].textContent=''
//Main Menu - start game btn -> skip || next prev text, last elem props.scene
// modal -> inside elems - text, if last elems || skip -> startGame
//inProcess game - if lost value, show 1 time - msg
//if take medical - show 1 time msg

//add each picure - for context
// audio - text -> выразителбно и четко записатьб
//audio - for pacman - death - текст типа - ты умер, ну ничего страшного.. etc

// prologue audio, 2 min -> ..
// Nyctalgia
// Current track: Nyctalgia- Time Changed Everything...Nyctalgia- Time Changed Everyt

//add sound Maga, soundeffect - my
//minus add -> with sound Maga
// Across The Waves
// Current track: A Gaze Into The HorizenA Gaze Into The Horizen

//restart - coin fix, and score after restart
//if pacman - death -> todo effect || notify

// option - on/off - sound,
//after lose || win -> show menu - restart/ go main menu
//if lose || win || prologu add prefix for image
//aduio fix play pause
// fix keydown manipulate menu
//if play game - not use space n, p button
//main menu -> fix, not work, set def values - like restart()
//if first start game -> show modal - press button for start
//block - keys -> asdw, -> when prologue

// fix - show prologue - each time
// fix restart - hide menu
//restart func -> -> show hide - modal fix ?
//todo - gameMenu show, func if gameMenu false -> mainMEnu true -> show mainMenu
// img.src = `./assets/${prefix}${textPos + 1}.png`;
//images -> in gameBoard -> coin -> coronavirus, ghost -> bat, pacman -> pacman, cookie - medical, live -> little count little baby
//add 3 sound - in prologue/win/lose - then - add soundeffects in game, own sound chomp etc
//add confetti - if win, if lose - blood confetti

//some case - .gameMenu, props.modal.children[1] = none
//if image not found -> not appedn in document

fix - repaeted call func -> when prologue, fisx repeated picture, intersect with prev gameState and current//1 win, 2 prolog

//show only parent, child elems - default -display - block

const showHide = (type) => {
  console.log("inside showHide", props.skip);

  if (!props.mainMenu) {
    if (type === "final") {
      props.modal.style.display = "block";
      //hide cont, restart, main menu
      // .modal a {
      props.modal.children[1].style.display = "none";
      //hist
      props.modal.children[3].style.display = "block";
      //fqa hidden
      props.modal.children[3].children[1].style.display = "none";
    }
  }
  //main menu
  if (props.mainMenu) {
    console.log("in main menu");
    //DRY
    props.modal.style.background = "rgba(0, 0, 0, 0)";
    props.modal.style.display = "block";
    props.modal.children[0].textContent = "";
    props.modal.children[1].children[0].style.display = "none";
    props.modal.children[1].children[1].style.display = "none";
    props.modal.children[1].children[2].style.display = "none";
    props.modal.children[3].style.display = "none";
    props.modal.children[2].style.display = "none";
    // props.modal.children[5].style.display = "none";

    if (!props.skip) {
      props.modal.children[4].style.display = "block";
      let links = document.getElementsByClassName("links")[0];
      //if start game,
      links.children[0].addEventListener("click", function () {
        props.modal.children[4].style.display = "none";
        props.modal.children[3].style.display = "block";
        //each start -> restore data
        props.mainMenu = false;
        restart();
      });
    } else if (props.skip) {
      props.modal.children[3].style.display = "block";
    }
    props.mainMenu = false;
  }
};

const beginParty = (type) => {
  let textPos = 0;
  let lastPos = 0;
  // unitsMT.pacman.pause = true;
  let text = [];
  text = [...history[type]]; // copy array data, not change by reference
  let msg = "";
  let prefix = "";
  if (type === "win") {
    prefix = "win";
    msg = "Твое достижения останутся на скалах предков... \\n";
  }
  if (type === "lose") {
    prefix = "lose";
    msg = "Ты умер раз и навсегда... пока \n";
  }
  //show first time
  props.modal.style.display = "block";
  // unitsMT.pacman.pause = true;
  let img = document.createElement("img");
  img.style.maxWidth = "800px";
  img.style.maxHeight = "600px";
  //show hfirst page in History
  if (type === "lose" || type === "win") {
    //history show
    props.modal.children[3].style.display = "block";
    //hide menu
    props.modal.children[1].style.display = "none";
    // props.sceneType = "";
    msg += `${unitsMT.pacman.score} Lives ${unitsMT.pacman.life}   ${props.time.min} months ${props.time.sec} days`;
    text.push(msg);
    lastPos = text.length - 1;
    props.sceneType = "";
    unitsMT.pacman.pause = true;
    //show gameMenu
  }
  if (type === "prologue") {
    props.modal.children[1].style.display = "none";
    prefix = "prologue";
    props.sceneType = "";
    lastPos = text.length - 1;
  }
  //first image
  img.src = `./assets/${prefix}${textPos + 1}.png`;
  props.modal.children[3].children[0].textContent = text[textPos];
  props.modal.children[3].children[0].append(img);

  document.addEventListener("keydown", (e) => {
    if (e.key !== 32) {
      if (e.key === " " || e.key === "n" || e.key === "p") {
        if (e.key === "p" && textPos > 0) {
          textPos--;
        }
        if (e.key === "n" && textPos <= lastPos) {
          textPos++;
          if (textPos == lastPos) {
            //prlogue case -> hide hide mainMenu, and
            if (type == "win" || type == "lose") {
              props.sceneType = "";
              //hide history, show menu
              props.modal.style.display = "block";
              props.modal.children[1].style.display = "block";
              props.modal.children[1].children[1].style.display = "block";
              props.modal.children[1].children[2].style.display = "block";
              props.modal.children[3].style.display = "none";
            } else {
              props.modal.style.display = "none";
            }
            textPos = 0;
            text = "";
          }
        }

        //if picture not foun - not append
        props.modal.children[3].children[0].textContent = text[textPos];
        //play/pause -next prev
        let audio = new Audio("./assets/text1.aac");
        // audio.play();
        img.src = `./assets/${prefix}${textPos + 1}.png`;
        console.log(img);
        props.modal.children[3].children[1].append(img);
        //skip case, after scene
        if (e.key === " ") {
          //add case - > prlogue case -> hide hide mainMenu, and
          if (type == "win" || type == "lose") {
            // case : win || lose -> show menu, else -> prologue -> hidden all
            props.modal.style.display = "block";
            props.modal.children[3].style.display = "none";
            props.modal.children[1].style.display = "block";
            props.modal.children[1].children[1].style.display = "block";
            props.modal.children[1].children[2].style.display = "block";
            props.skip = true;
            props.sceneType = "";
          } else {
            props.modal.style.display = "none";
          }
          textPos = 0;
          text = "";
        }
        //delete prev called ds
        console.log(
          textPos,
          "pos picture",
          text.length,
          "len text arr",
          type,
          "type",
          props.sceneType,
          "type",
          e.keyCode,
          "code"
        );
      }
    }
  });
};

// if (document.URL.includes("index.html")) {
//   let start = 0;
//   let links = document.getElementsByClassName("links")[0];
//   document.addEventListener("keydown", (e) => {
//     if (e.code === "ArrowDown") {
//       if (start < 3) {
//         links.children[start].style.color = "#fff";
//         start++;
//         links.children[start].style.color = "red";
//       }
//     }
//     if (e.code === "ArrowUp") {
//       if (start > 0) {
//         links.children[start].style.color = "#fff";
//         start--;
//         links.children[start].style.color = "red";
//       }
//     }
//     if (e.code === "Enter") {
//       links.children[start].click();
//     }
//   });
// }

document.addEventListener("keydown", (e) => {
  if (e.code in keys) {
    keys[e.code] = true;
  }
  if (
    e.code === "KeyA" ||
    e.code === "KeyD" ||
    e.code === "KeyS" ||
    e.code === "KeyW"
  ) {
    //cahnge bg pacman & ghost if canKill
    if (unitsMT.pacman.canKill) {
      obj.pacman.style.background = "red";
      obj.redGhost.style.opacity = ".4";
      obj.orangeGhost.style.opacity = ".4";
      obj.pinkGhost.style.opacity = ".4";
      obj.cyanGhost.style.opacity = ".4";
    } else {
      obj.pacman.style.background = "yellow";
      obj.redGhost.style.opacity = "1";
      obj.orangeGhost.style.opacity = "1";
      obj.pinkGhost.style.opacity = "1";
      obj.cyanGhost.style.opacity = "1";
    }
    // if (unitsMT.pacman.death) {
    //   keys.death = false;
    //   // obj.pacman.classList.add("pacman-death");
    // }
    // && props.skip
    if (!props.inPlay) {
      props.inPlay = true;
      props.rafId = requestAnimationFrame(step);
      //time
      startTime();
    }
    // && props.skip
  } else if (e.code === "Escape" && !props.mainMenu) {
    console.log("esc menu in game");
    endGame("escape");
  }
});
//transform translate each item - change posit 0 in Dom
const render = (...args) => {
  args.forEach((el, i) => {
    obj[el.nick].style.transform = `translate(${el.posX}px, ${el.posY}px)`;
  });
};

const restart = () => {
  //lol  location.reload();
  console.log(5, props.skip, "rest");

  //set default values
  props.inPlay = false;
  props.time.min = 0;
  props.time.sec = 0;
  keys.restart = true;
  //set def value in main Thread
  unitsMT.pacman.posX = 425;
  unitsMT.pacman.posY = 695;
  unitsMT.pacman.indexMap = 658;
  unitsMT.pacman.life = 5;
  unitsMT.pacman.countCoin = 0;
  unitsMT.pacman.score = 0;
  console.log(props.sceneType);

  // if (props.sceneType == "" && props.finalState) {
  //   props.modal.children[3].style.display = "none";
  // }

  // props.skip = true;

  obj.pacman.style.transform = `translate(${unitsMT.pacman.posX}px, ${unitsMT.pacman.posY}px)`;
  //show notify
  props.notify.style.display = "block";
  //update time
  clearInterval(interval);
  //return opacity coin elem, set timeout?
  for (let i = 0; i < 869; i++) {
    if (props.grid.children[i].children[0] !== undefined) {
      if (
        props.grid.children[i].children[0].className === "coin" ||
        props.grid.children[i].children[0].className === "cookie"
      ) {
        props.grid.children[i].children[0].style.opacity = 1;
      }
    }
  }
  unitsMT.pacman.pause = false;
};

//menu - modal window ?
const gameMenu = () => {
  props.modal.children[1].style.display = "block";
  unitsMT.pacman.pause = true;
};
//modal child - 1 - gameMenu,

const endGame = (type) => {
  let size = 0;
  size = 2;
  //show hide menu items
  props.modal.style.display = "block";
  // props.modal.children[1].style.display = "block";
  showHide(type);
  if (type === "escape") {
    props.modal.children[1].style.display = "block";
    //continue btn
    props.modal.children[1].children[0].style.display = "block";
    props.modal.children[1].children[1].style.display = "block";
    props.modal.children[1].children[2].style.display = "block";
    props.modal.children[3].style.display = "none";
    props.mainMenu = false;
    unitsMT.pacman.pause = true;
    // showHide(type);
    size = 3;
    //continue btn
    props.modal.children[1].children[0].onclick = (e) => {
      rafId = requestAnimationFrame(step);
      unitsMT.pacman.pause = false;
      props.inPlay = true;
      props.modal.style.display = "none";
      startTime();
      props.modal.children[1].style.display = "none";
    };
  }
  //show notify - you win || lose
  // props.sceneType === "prologue";
  //
  if (props.sceneType === "win" || props.sceneType === "lose") {
    // show only text
    beginParty(props.sceneType);
    // then show menu hide text
  }
  //keydown menu
  let links = document.getElementsByClassName("modal")[0];
  let start = 0;

  document.addEventListener("keydown", (e) => {
    if (e.keyCode === 38) {
      if (start > 0) {
        links.children[start].style.color = "#000";
        start--;
        links.children[start].style.color = "cyan";
      }
    }
    if (e.keyCode === 40) {
      if (start < size) {
        links.children[start].style.color = "#000";
        start++;
        links.children[start].style.color = "cyan";
      }
    }
    if (e.code === "Enter") {
      links.children[start].click();
    }
  });
  //onclick menu  //restart btn
  props.modal.children[1].children[1].onclick = (e) => {
    //set def value
    props.modal.children[1].style.display = "none";
    restart();
  };
  //main menu
  props.modal.children[1].children[2].onclick = (e) => {
    props.mainMenu = true;
    props.skip = false;
    unitsMT.pacman.pause = false;
    showHide();
    beginParty("prologue");
    //show menu, another hide
  };
};

const step = () => {
  if (props.inPlay) {
    unitsMT.cool--;
    if (unitsMT.cool < 0) {
      worker.port.postMessage({ key: keys }); //key state - pacman
      //not use forEach, receive data from bg thread - set updated data
      worker.port.onmessage = (e) => {
        unitsMT.cyanGhost.posX = e.data.cyanGhost.posX;
        unitsMT.cyanGhost.posY = e.data.cyanGhost.posY;

        unitsMT.redGhost.posX = e.data.redGhost.posX;
        unitsMT.redGhost.posY = e.data.redGhost.posY;

        unitsMT.orangeGhost.posX = e.data.orangeGhost.posX;
        unitsMT.orangeGhost.posY = e.data.orangeGhost.posY;

        unitsMT.pinkGhost.posX = e.data.pinkGhost.posX;
        unitsMT.pinkGhost.posY = e.data.pinkGhost.posY;
        //set updated data from bg thread
        unitsMT.pacman.posX = e.data.pacman.posX;
        unitsMT.pacman.posY = e.data.pacman.posY;
        unitsMT.pacman.indexMap = e.data.pacman.indexMap;
        unitsMT.pacman.score = e.data.pacman.score;
        unitsMT.pacman.life = e.data.pacman.life;
        unitsMT.pacman.countCoin = e.data.pacman.countCoin;
        unitsMT.pacman.canKill = e.data.pacman.canKill;
        unitsMT.pacman.transX = e.data.pacman.transX;
        unitsMT.pacman.death = e.data.pacman.death;
        keys.restart = e.data.pacman.restart;

        // console.log(
        //   unitsMT.pacman.indexMap,
        //   e.data.pacman.indexMap,
        //   "index",
        //   unitsMT.pacman.score,
        //   e.data.pacman.score,
        //   "score",
        //   unitsMT.pacman.life,
        //   e.data.pacman.life,
        //   "life",
        //   unitsMT.pacman.countCoin,
        //   e.data.pacman.countCoin,
        //   "coin",
        //   unitsMT.pacman.pause,
        //   "pause",
        //   props.sceneType,
        //   props.mainMenu
        // );
      };
      //if changed pacman index, eqaul 4 || 0, add score, change - currentPos = 0, -> currPos = 9
      if (mapGame[unitsMT.pacman.indexMap] !== 1) {
        if (
          unitsMT.pacman.indexMap !== 391 &&
          unitsMT.pacman.indexMap !== 420 &&
          unitsMT.pacman.indexMap !== 350 &&
          unitsMT.pacman.indexMap !== 349
        ) {
          //change opacity - coin
          mapItemsInDom[unitsMT.pacman.indexMap].children[0].style.opacity = 0;
        }
        //change mouth - pacman
        obj.pacman_mouth.style.transform = unitsMT.pacman.transX;
      }
      if (unitsMT.pacman.life > 0) {
        if (unitsMT.pacman.countCoin === 4) {
          props.sceneType = "win";
          endGame("win");
        }
      } else {
        props.sceneType = "lose";
        endGame("lose");
      }
      //render
      obj.pacman.style.transform = `translate(${unitsMT.pacman.posX}px, ${unitsMT.pacman.posY}px)`;
      obj.redGhost.style.transform = `translate(${unitsMT.redGhost.posX}px, ${unitsMT.redGhost.posY}px)`;
      obj.orangeGhost.style.transform = `translate(${unitsMT.orangeGhost.posX}px, ${unitsMT.orangeGhost.posY}px)`;
      obj.cyanGhost.style.transform = `translate(${unitsMT.cyanGhost.posX}px, ${unitsMT.cyanGhost.posY}px)`;
      obj.pinkGhost.style.transform = `translate(${unitsMT.pinkGhost.posX}px, ${unitsMT.pinkGhost.posY}px)`;
      //updated value - render scoreboard
      props.scoreBoard.children[0].textContent = `Score ${unitsMT.pacman.score} Lives ${unitsMT.pacman.life}  ${props.time.min} months ${props.time.sec} days`;
      //cooldwon, 5 * 16.7 -> reaction each 83ms
      unitsMT.cool = 6;
    }
    rafId = requestAnimationFrame(step);
    if (unitsMT.pacman.pause) {
      window.cancelAnimationFrame(rafId);
    }
  }
};

const createBoard = () => {
  //create each block -> get data from mapGame array
  mapGame.forEach((el, idx) => {
    createBlock(el);
  });

  // get static elems -> add in Obejct, then add array - tags, change values -> render new value
  for (let i = 0; i < props.size; i++) {
    props.x += 30 + "px "; //cell grid height, width count - for grid
  }
  // 31 count height field Map
  for (let i = 0; i < props.h; i++) {
    props.y += 30 + "px "; //cell grid rows count, 31px
  }
  //set grid rows, columns, size - count
  props.grid.style.gridTemplateColumns = props.x;
  props.grid.style.gridTemplateRows = props.y;
  //board localy dom, props.grid -> in DOm browser inserted
};
const createBlock = (type) => {
  let div = document.createElement("div");
  div.classList.add("box");
  //create new div -> add class, append object - props.grid
  if (type === 0) {
    const coin = document.createElement("div");
    coin.classList.add("coin");
    div.append(coin);
  } else if (type === 1) {
    let wall = document.createElement("div");
    wall.classList.add("wall");
    div.append(wall);
  } else if (type === 4) {
    let cookie = document.createElement("div");
    cookie.classList.add("cookie");
    div.append(cookie);
  } else if (type === 6) {
    let door = document.createElement("div");
    door.classList.add("doorEnemy");
    div.append(door);
  } else if (type === 8) {
    let teleport = document.createElement("div");
    teleport.classList.add("teleport");
    div.append(teleport);
  } else if (type === 9) {
    let free = document.createElement("div");
    free.classList.add("free");
    div.append(free);
  }
  div.type = type;
  mapItemsInDom.push(div);
  props.grid.append(div);
};
